syntax = "proto3";
package kyrodb.v1;

service Kyrodb {
  // Core data operations
  rpc Lookup(LookupReq) returns (LookupResp);
  rpc Get(GetReq) returns (GetResp);
  rpc Put(PutReq) returns (PutResp);
  rpc BatchGet(BatchGetReq) returns (BatchGetResp);
  rpc BatchPut(BatchPutReq) returns (BatchPutResp);
  rpc Append(AppendReq) returns (AppendResp);
  rpc BatchAppend(stream BatchAppendReq) returns (BatchAppendResp);

  // Streaming operations
  rpc Subscribe(SubscribeReq) returns (stream Event);
  rpc Replay(ReplayReq) returns (stream Event);

  // Admin operations
  rpc Snapshot(SnapshotReq) returns (SnapshotResp);
  rpc Compact(CompactReq) returns (CompactResp);
  rpc GetStats(StatsReq) returns (StatsResp);
  rpc Warmup(WarmupReq) returns (WarmupResp);
  rpc GetOffset(OffsetReq) returns (OffsetResp);

  // Vector operations
  rpc VectorInsert(VectorInsertReq) returns (VectorInsertResp);
  rpc VectorSearch(VectorSearchReq) returns (VectorSearchResp);

  // SQL operations
  rpc ExecuteSql(SqlReq) returns (SqlResp);

  // RMI operations (feature-gated)
  rpc BuildRmi(BuildRmiReq) returns (BuildRmiResp);
}

// Authentication metadata
message AuthMetadata {
  string token = 1;
  UserRole role = 2;
}

enum UserRole {
  READ_ONLY = 0;
  READ_WRITE = 1;
  ADMIN = 2;
}

// Core data messages
message LookupReq { uint64 key = 1; }
message LookupResp { bool found = 1; uint64 offset = 2; }

message GetReq { uint64 key = 1; }
message GetResp { bool found = 1; bytes value = 2; }

message PutReq { uint64 key = 1; bytes value = 2; }
message PutResp { uint64 offset = 1; }

message BatchGetReq { repeated uint64 keys = 1; }
message BatchGetResp {
  message BatchGetItem {
    uint64 key = 1;
    bool found = 2;
    bytes value = 3;
  }
  repeated BatchGetItem items = 1;
}

message BatchPutReq {
  message BatchPutItem {
    uint64 key = 1;
    bytes value = 2;
  }
  repeated BatchPutItem items = 1;
}
message BatchPutResp { repeated uint64 offsets = 1; }

message AppendReq { bytes payload = 1; }
message AppendResp { uint64 offset = 1; }

message BatchAppendReq { bytes payload = 1; }
message BatchAppendResp { repeated uint64 offsets = 1; }

// Streaming messages
message SubscribeReq { uint64 from_offset = 1; }
message ReplayReq { uint64 start = 1; optional uint64 end = 2; }

message Event {
  uint64 offset = 1;
  uint64 timestamp = 2;
  string request_id = 3;
  bytes payload = 4;
}

// Admin messages
message SnapshotReq {}
message SnapshotResp { bool success = 1; string error = 2; }

message CompactReq {}
message CompactResp {
  bool success = 1;
  string error = 2;
  uint64 before_bytes = 3;
  uint64 after_bytes = 4;
  uint64 segments_removed = 5;
  uint64 segments_active = 6;
  uint64 keys_retained = 7;
}

message StatsReq {}
message StatsResp {
  uint64 total_events = 1;
  uint64 wal_size_bytes = 2;
  uint64 snapshot_size_bytes = 3;
  uint32 wal_segments = 4;
  uint64 current_offset = 5;
  string index_type = 6;
  uint64 rmi_leaves = 7;
  uint64 rmi_size_bytes = 8;
}

message WarmupReq {}
message WarmupResp { string status = 1; }

message OffsetReq {}
message OffsetResp { uint64 offset = 1; }

// Vector messages
message VectorInsertReq { uint64 key = 1; repeated float vector = 2; }
message VectorInsertResp { uint64 offset = 1; }

message VectorSearchReq { repeated float query = 1; uint32 k = 2; }
message VectorSearchResp {
  message VectorResult {
    uint64 key = 1;
    float distance = 2;
  }
  repeated VectorResult results = 1;
}

// SQL messages
message SqlReq { string sql = 1; }
message SqlResp {
  oneof response {
    SqlAck ack = 1;
    SqlRows rows = 2;
    SqlVecRows vec_rows = 3;
  }
  string error = 4;
}

message SqlAck { uint64 offset = 1; }
message SqlRows {
  message SqlRow {
    uint64 key = 1;
    bytes value = 2;
  }
  repeated SqlRow rows = 1;
}
message SqlVecRows {
  message SqlVecRow {
    uint64 key = 1;
    float distance = 2;
  }
  repeated SqlVecRow rows = 1;
}

// RMI messages
message BuildRmiReq {}
message BuildRmiResp { bool ok = 1; uint64 count = 2; }
